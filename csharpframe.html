<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Data frame manipulation in C#
</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Easy to use .NET library for data manipulation and scientific programming">
    <meta name="author" content="BlueMountain Capital">

    <script src="http://code.jquery.com/jquery-1.8.0.js"></script>
    <script src="http://code.jquery.com/ui/1.8.23/jquery-ui.js"></script>
    <script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet">

    <link type="text/css" rel="stylesheet" href="http://bluemountaincapital.github.io/Deedle/content/style.css" />
    <script type="text/javascript" src="http://bluemountaincapital.github.io/Deedle/content/tips.js"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container">
      <div class="masthead">
        <ul class="nav nav-pills pull-right">
          <li><a href="http://fsharp.org">fsharp.org</a></li>
          <li><a href="http://github.com/BlueMountainCapital/Deedle">github page</a></li>
          <li><a href="http://fsharp.github.io/FSharp.Charting/">F# Charting</a></li>
          <li><a href="http://bluemountaincapital.github.io/FSharpRProvider">R Type Provider</a></li>
          <li><a href="http://fsharp.github.io/FSharp.Data/">F# Data</a></li>
        </ul>
        <h3 class="muted">Deedle</h3>
      </div>
      <hr />
      <div class="row">
        <div class="span9" id="main">
          
<h1>Data frame manipulation in C#</h1>

<p>In this section, we look at working with Deedle data frame. Data frame lets you manipulate and
analyze data consisting of multiple features (properties) with multiple observations (records).
You can think of data frame as a data table or a spreadsheet. When working with data frames, you'll
often need to work on individual series (either rows or columns) of the frame, so it is recommended
to look at the <a href="csharpseries.html">page discussing series</a> first.</p>

<p>You can also get the samples on this page as a <a href="https://github.com/BlueMountainCapital/Deedle/blob/master/docs/content/csharp/Frame.cs">C# source file</a>
from GitHub and run the samples.</p>

<a name="understanding"></a>

<h2>What is a data frame</h2>

<ul>
<li><p><strong>Row and column key to values</strong> - data frame is represented using a type <code>Frame&lt;TRowKey, TColKey&gt;</code> and
you can view it as a mapping from row and column keys to values. Note that the values in data frame can
be heterogeneous and Deedle does not track this information statically - when accessing column/row, you
need to explicitly specify the type of values you want to get (although Deedle makes this easier when
you work with numeric data).</p></li>
<li><p><strong>Typical uses</strong> - although you can use any type for column and row keys, the typical use is having column 
keys of type <code>string</code> representing different (named) properties and row keys of type <code>int</code> (unique IDs)
or <code>DateTimeOffset</code> for time series data.</p></li>
<li><p><strong>Series collection</strong> - another way to look at data frame is that it is a collection of series with 
the same (row) index. This is also how frames are represented internally, so using this intuition will
probably lead you to faster and more idiomatic code. For example, you can store multiple series with
different stock prices in a data frame and they will all be aligned to the same (row) index.</p></li>
<li><p><strong>Limited mutability</strong> - the internal data structures of data frame are immutable (i.e. series and a type
representing indices). However, when working with data frame, you can mutate the frame and add/remove
columns. When adding column, a new index is created and local field of the frame pointing to the index is
updated, but no data series or indices (that may be shared by other types) are changed.
This makes research-style operations more convenient and makes the library more practical.</p></li>
</ul>

<a name="creating"></a>

<h2>Creating and loading data frames</h2>

<p>Let's start with a number of examples showing how to create data frames. The most common scenario is that you
already have some code that reads the data - perhaps from a database or some other source - and you want 
to convert it to data frame. Any collection of .NET objects can be turned to data frame using <code>Frame.FromRecords</code>:</p>

<pre lang="csharp"><span class="c">// Create a collection of anonymous types</span>
<span class="k">var</span> rnd = <span class="k">new</span> Random();
<span class="k">var</span> objects = Enumerable.Range(0, 10).Select(i =&gt;
  <span class="k">new</span> { Key = <span class="s">"ID_"</span> + i.ToString(), Number = rnd.Next() });

<span class="c">// Create data frame with properties as column names</span>
<span class="k">var</span> dfObjects = Frame.FromRecords(objects);
dfObjects.Print();</pre>

<p>In this sample, we use simple LINQ construction to generate collection with anonymous types containing properties
<code>Key</code> and <code>Number</code>. The <code>FromRecords</code> method uses reflection to get public readable properties of the type and
so the result of the <code>Print</code> method looks as follows:</p>

<pre lang="text">-    Key   Number
0 -&gt; ID_0  997104221
1 -&gt; ID_1  50365464
2 -&gt; ID_2  1777994880
(...)</pre>

<p>As an alternative, you can also construct data frame by generating a collection of explicitly created rows. 
A row is just a series of type <code>Series&lt;TColKey, TValue&gt;</code> so you can use any of the techniques described in 
<a href="csharpseries.html#creating">creating series</a>. Here, we use <code>SeriesBuilder&lt;string&gt;</code> which is the easiest way
to create series imperatively by adding columns:</p>

<pre lang="csharp"><span class="c">// Generate collection of rows</span>
<span class="k">var</span> rows = Enumerable.Range(0, 100).Select(i =&gt; {
  <span class="c">// Build each row using series builder &amp; return </span>
  <span class="c">// KeyValue representing row key with row data</span>
  <span class="k">var</span> sb = <span class="k">new</span> SeriesBuilder&lt;<span class="k">string</span>&gt;();
  sb.Add(<span class="s">"Index"</span>, i);
  sb.Add(<span class="s">"Sin"</span>, Math.Sin(i / 100.0));
  sb.Add(<span class="s">"Cos"</span>, Math.Cos(i / 100.0));
  <span class="k">return</span> KeyValue.Create(i, sb.Series); 
});

<span class="c">// Turn sequence of row information into data frame</span>
<span class="k">var</span> df = Frame.FromRows(rows);</pre>

<p>Finally, you can also easily load data frames from a CSV file. The <code>Frame.ReadCsv</code> function</p>

<pre lang="csharp"><span class="c">// Read MSFT &amp; FB stock prices from a CSV file</span>
<span class="k">var</span> msftRaw = Frame.ReadCsv(Path.Combine(root, <span class="s">"../data/stocks/msft.csv"</span>));
<span class="k">var</span> fbRaw = Frame.ReadCsv(Path.Combine(root, <span class="s">"../data/stocks/fb.csv"</span>));</pre>

<p>The function automatically recognizes the names of columns (if the CSV file does not have headers, you can
specify optional parameter <code>hasHeaders:false</code>). It also infers the type of values, so that you can later work
with numeric columns in a standard way. Here, we are reading Yahoo stock prices, so the resulting frame looks
as follows:</p>

<pre lang="text">-       Date       Open  High  Low   Close Volume     Adj Close
0    -&gt; 2013-11-07 37.96 38.01 37.43 37.50 60437400   37.50
1    -&gt; 2013-11-06 37.24 38.22 37.06 38.18 88615100   38.18
:       ...        ...   ...   ...   ...   ...        ...
6972 -&gt; 1986-03-17 29.00 29.75 29.00 29.50 133171200  0.08
6973 -&gt; 1986-03-14 28.00 29.50 28.00 29.00 308160000  0.07
6974 -&gt; 1986-03-13 25.50 29.25 25.50 28.00 1031788800 0.07</pre>

<a name="indices"></a>

<h2>Working with row and column indices</h2>

<p>Reading data from CSV file or from .NET objects typically gives us data frame <code>Frame&lt;int, string&gt;</code> where the
rows are indexed by <code>int</code> (representing the number of the row) and columns are names (<code>string</code> values). 
When we want to combine data from multiple data sources or perform some further processing, this is not 
always what we need.</p>

<p>For example, for the MSFT and FB stock prices, we want the row index to be <code>DateTime</code> (so that we can 
align the prices based on dates) and we also need to order the rows (because aligning that we'll do in
the next step is only allowed on ordered frames and series):</p>

<pre lang="csharp"><span class="c">// Get MSFT &amp; FB stock prices indexed by data</span>
<span class="k">var</span> msft = msftRaw.IndexRows&lt;DateTime&gt;(<span class="s">"Date"</span>).OrderRows();
<span class="k">var</span> fb = fbRaw.IndexRows&lt;DateTime&gt;(<span class="s">"Date"</span>).OrderRows();

<span class="c">// And rename columns to avoid overlap</span>
msft.RenameSeries(s =&gt; <span class="s">"Msft"</span> + s);
fb.RenameSeries(s =&gt; <span class="s">"Fb"</span> + s);</pre>

<p>The <code>IndexRows&lt;T&gt;(..)</code> method takes the name of the column that we want to use as an index and it also takes
a type parameter <code>T</code> that specifies the type of the column (because this is not statically known). We use
<code>DateTime</code> and benefit from the fact that the CSV reader already recognized the column type. Next, we sort
the entire data frame by the new row index using <code>OrderRows</code>.</p>

<p>The second part of the snippet renames the columns (using a mutating <code>RenameSeries</code> operation) so that the
column name includes the name of the company. We need this, because we later want to join the two data frames
and that is only possible when column keys do not overlap.</p>

<pre lang="csharp"><span class="c">// Read US debt data from a CSV file</span>
<span class="k">var</span> debt = Frame.ReadCsv(Path.Combine(root, <span class="s">"../data/us-debt.csv"</span>));
<span class="c">// Index by Year column and</span>
<span class="k">var</span> debtByYear = debt
  .IndexRows&lt;<span class="k">int</span>&gt;(<span class="s">"Year"</span>)
  .IndexColumnsWith(<span class="k">new</span>[] { <span class="s">"Year"</span>, <span class="s">"GDP"</span>, <span class="s">"Population"</span>, <span class="s">"Debt"</span>, <span class="s">"?"</span> });</pre>

<a name="joining"></a>

<h2>Joining and aligning data frames</h2>

<pre lang="csharp"><span class="c">// Inner join (take intersection of dates)</span>
<span class="k">var</span> joinIn = msft.Join(fb, JoinKind.Inner);
<span class="c">// Outer join (take union &amp; fill with missing)</span>
<span class="k">var</span> joinOut = msft.Join(fb, JoinKind.Outer);</pre>

<p>a</p>

<pre lang="csharp"><span class="c">// Shift MSFT observations by +1 hour for testing</span>
<span class="k">var</span> msftShift = msft.SelectRowKeys(k =&gt; k.Key.AddHours(1.0));

<span class="c">// MSFT data are missing because keys do not match</span>
<span class="k">var</span> joinLeftWrong = fb.Join(msftShift, JoinKind.Left);

<span class="c">// This works! Find the value for the nearest smaller key</span>
<span class="c">// (that is, for the nearest earlier time with value)</span>
<span class="k">var</span> joinLeft = fb.Join(msftShift, JoinKind.Left, Lookup.NearestSmaller);
joinLeft.Print();</pre>

<a name="data"></a>

<h2>Accessing data and series operations</h2>

<pre lang="csharp"><span class="c">// Drop series from a data frame</span>
joinIn.DropSeries(<span class="s">"MsftAdj Close"</span>);
joinIn.DropSeries(<span class="s">"FbAdj Close"</span>);

<span class="c">// Add new series to a frame</span>
joinIn.AddSeries(<span class="s">"MsftDiff"</span>, msDiff);
joinIn.Print();</pre>

<p>a</p>

<pre lang="csharp"><span class="c">// Get MSFT and FB opening prices and calculate the difference</span>
<span class="k">var</span> msOpen = joinIn.GetSeries&lt;<span class="k">double</span>&gt;(<span class="s">"MsftOpen"</span>);
<span class="k">var</span> msClose = joinIn.GetSeries&lt;<span class="k">double</span>&gt;(<span class="s">"MsftClose"</span>);
<span class="k">var</span> msDiff = msClose - msOpen;</pre>

<p>a</p>

<pre lang="csharp"><span class="c">// Get row and then look at row properties</span>
<span class="k">var</span> row = joinIn.Rows[<span class="k">new</span> DateTime(2013, 1, 4)];
<span class="k">var</span> msLo = row.GetAs&lt;<span class="k">double</span>&gt;(<span class="s">"MsftLow"</span>);
<span class="k">var</span> msHi = row.GetAs&lt;<span class="k">double</span>&gt;(<span class="s">"MsftHigh"</span>);

<span class="c">// Get value for a specified column &amp; row keys</span>
<span class="k">var</span> diff = joinIn[<span class="s">"MsftDiff"</span>, <span class="k">new</span> DateTime(2013, 1, 4)];</pre>

<a name="linq"></a>

<h2>LINQ to data frame</h2>

<pre lang="csharp"><span class="c">// Project rows into a new series using the Select method</span>
<span class="k">var</span> diffs = joinIn.Rows.Select(kvp =&gt;
  kvp.Value.GetAs&lt;<span class="k">double</span>&gt;(<span class="s">"MsftOpen"</span>) - 
    kvp.Value.GetAs&lt;<span class="k">double</span>&gt;(<span class="s">"FbOpen"</span>));</pre>

<p><code>SelectKeys</code>
and <code>SelectOptional</code></p>

<pre lang="csharp"><span class="c">// Filter rows using a specified condition </span>
<span class="k">var</span> msftGreaterRows = joinIn.Rows.Where(kvp =&gt;
  kvp.Value.GetAs&lt;<span class="k">double</span>&gt;(<span class="s">"MsftOpen"</span>) &gt; 
    kvp.Value.GetAs&lt;<span class="k">double</span>&gt;(<span class="s">"FbOpen"</span>));

<span class="c">// Transform row collection into a new data frame</span>
<span class="k">var</span> msftGreaterDf = Frame.FromRows(msftGreaterRows);</pre>


        </div>
        <div class="span3">
          <a href="https://nuget.org/packages/Deedle">
            <img src="http://bluemountaincapital.github.io/Deedle/images/logo.png" style="width:140px;height:140px;margin:10px 0px 0px 35px;border-style:none;" />
          </a>

          <ul class="nav nav-list" id="menu">
            <li class="nav-header">Deedle</li>
            <li><a href="http://bluemountaincapital.github.io/Deedle/index.html">Home page</a></li>
            <li class="divider"></li>
            <li><a href="https://nuget.org/packages/Deedle">Get Library via NuGet</a></li>
            <li><a href="http://github.com/BlueMountainCapital/Deedle">Source Code on GitHub</a></li>
            <li><a href="http://github.com/BlueMountainCapital/Deedle/blob/master/LICENSE.md">License (BSD)</a></li>
            <li><a href="http://github.com/BlueMountainCapital/Deedle/blob/master/RELEASE_NOTES.md">Release notes</a></li>
            <li><a href="http://bluemountaincapital.github.io/Deedle/design.html">Design notes</a></li>
            <li><a href="http://stackoverflow.com/questions/tagged/deedle">Ask a question!</a></li>
            
            <li class="nav-header">Using from F#</li>
            <li>
              <a href="http://bluemountaincapital.github.io/Deedle/tutorial.html">Quick start tutorial</a>
            </li>
            <li>
              <a href="http://bluemountaincapital.github.io/Deedle/features.html">Advanced frame manipulation</a>
            </li>
            <li>
              <a href="http://bluemountaincapital.github.io/Deedle/timeseries.html">Working with time series</a>
            </li>
            <li>
              <a href="http://bluemountaincapital.github.io/Deedle/rinterop.html">Using R with Deedle</a>
            </li>

            <li class="nav-header">Using from C#</li>
            <li><a href="http://bluemountaincapital.github.io/Deedle/csharpintro.html">Getting started</a></li>
            <li>
              <a href="http://bluemountaincapital.github.io/Deedle/csharpseries.html">Working with data series</a>
            </li>
            <li>
              <a href="http://bluemountaincapital.github.io/Deedle/csharpframe.html">Working with data frames</a>
              <ul class="nav nav-list">
                <li><a href="http://bluemountaincapital.github.io/Deedle/csharpframe.html#understanding">What is a data frame</a></li>
                <li><a href="http://bluemountaincapital.github.io/Deedle/csharpframe.html#creating">Creating data frames</a></li>
                <li><a href="http://bluemountaincapital.github.io/Deedle/csharpframe.html#indices">Row and column indices</a></li>
                <li><a href="http://bluemountaincapital.github.io/Deedle/csharpframe.html#joining">Joining &amp; aligning</a></li>
                <li><a href="http://bluemountaincapital.github.io/Deedle/csharpframe.html#data">Series operations</a></li>
                <li><a href="http://bluemountaincapital.github.io/Deedle/csharpframe.html#linq">LINQ to Frames</a></li>
              </ul>
            </li>

            <li class="nav-header">Documentation</li>
            <li><a href="http://bluemountaincapital.github.io/Deedle/reference/index.html">API Reference</a></li>

            <li class="nav-header">Samples</li>
            <li><a href="http://bluemountaincapital.github.io/Deedle/lazysource.html">Lazy data loading</a></li>
            <li><a href="http://bluemountaincapital.github.io/Deedle/samples/volatility.html">Price volatility</a></li>
            <li><a href="http://bluemountaincapital.github.io/Deedle/samples/titanic.html">Titanic survivors</a></li>
          </ul>
        </div>
      </div>
    </div>
    <a href="http://github.com/BlueMountainCapital/Deedle"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"></a>
    <script>
      (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
          (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date(); a = s.createElement(o),
        m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
      })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
      ga('create', 'UA-45379232-1', 'bluemountaincapital.github.io');
      ga('send', 'pageview');
    </script>
  </body>
</html>